{% extends "base.html" %}

{% block title %}<title>mkch - {{board.code}}</title>{% endblock %}

{% block body %}
	<div class="container">
		<form class="search-form">
			<input id="search" name="title" placeholder="Поиск..." type="text" value="{{ request.GET.title }}">
            {% if request.GET.noredirect %}
                <input type="hidden" name="noredirect" value="1">
            {% endif %}
            {% if archive %}
                <input type="hidden" name="archive" value="1">
            {% endif %}
			<input type="submit" value="Искать" />
		</form>

		<div class="board-container">
			{% if archive %}
				{% load static %}
				<img class="small-icon" src="{% static 'media/archive.svg' %}"></img>
			{% endif %}

			{% if board.banner %}
				<div class="board-banner">
					<img src="{{board.banner.url}}" class="banner-image"></img>
				</div>
			{% endif %}

			{% if board.detail_description %}
				<h3 class="description">{{board.detail_description}}</h3>
			{% endif %}

		<div class="new-thread-button">
			{% if user.is_staff or not board.lockdown and board.enable_posting %}
				<a href="/boards/board/{{board.code}}/new">> начать тред <</a>
			{% endif %}
   		</div>

		<div class="pagination top">
			<span class="step-links">
				{% if page_obj.has_previous %}
                    <a href="?page=1{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">&laquo;1</a>
					{% if page_obj.previous_page_number != 1 %}
						<a href="?page={{ page_obj.previous_page_number }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">&lsaquo;{{ page_obj.previous_page_number }}</a>
					{% endif %}
				{% endif %}

				<span class="current">{{ page_obj.number }}</span>

				{% if page_obj.has_next %}
					{% if page_obj.next_page_number != page_obj.paginator.num_pages %}
						<a href="?page={{ page_obj.next_page_number }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">{{ page_obj.next_page_number }}&rsaquo;</a>
					{% endif %}
					<a href="?page={{ page_obj.paginator.num_pages }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">{{ page_obj.paginator.num_pages }}&raquo;</a>
				{% endif %}
			</span>
		</div>

		<div id="thread-list">
			{% for thread in thread_list %}
				<div class="thread-container">
					<div class="thread-item">
						<div class="thread-file" onclick="">
						{% for file in thread.threadfile_set.all %}
								{% if file.fclass == "photo" %}
									<img src="{{file.file.url}}" id={{file.file.url}} class="thread-image{% if blur and thread.is_nsfw %}-nsfw{% endif %}" onclick="createImageFloatingDiv('{{file.file.url}}')"></img>
								{% elif file.fclass == "video" %}
									<video controls="" src="{{file.file.url}}"></video>
								{% else %}
									<a href="{{file.file.url}}">{{file.file.name}}</a>
								{% endif %}
						{% endfor %}
						</div>

						<div class="thread-header list">
							<div class="thread-info list" onclick="window.location.href='/boards/board/{{thread.board.code}}/thread/{{thread.id}}'">
								<h1 class="thread-title list">
									{{thread.title}}
								</h1>
								<h2 class="thread-stats list">
									{{thread.comment_set.count}} СМС, 
										{{thread.rating}}PP 
									<span class="post-date">{{thread.creation | date}} <div class="date-detail" hidden="">{{thread.creation | date:"d/m/Y H:i:s | U"}}</div></span>
								</h2>
							</div>
							
                            <div style="display: flex; align-items: center;">
                                <h1 class="thread-id list">#{{thread.id}}</h1>
                                
                                {% if user.is_staff %}
                                    {% load static %}
                                    <div class="admin-menu-container">
                                        <img class="small-icon admin-menu-trigger" src="{% static 'media/context-menu.svg' %}" onclick="toggleContextMenu(event, '{{thread.id}}')" title="Меню">
                                        
                                        <div id="admin-menu-{{thread.id}}" class="admin-context-menu hidden">
                                            <ul>
                                                <li onclick="pin({{thread.id}})">{% if thread.pinned %}Открепить{% else %}Закрепить{% endif %}</li>
                                                <li onclick="persist({{thread.id}})">{% if thread.persistent %}Утопить{% else %}Сделать плавающим{% endif %}</li>
                                                <li onclick="archiveThread({{thread.id}})">{% if thread.archived %}Разархивировать{% else %}Архивировать{% endif %}</li>
                                                <li><a href="/admin/boards/thread/{{thread.id}}/change/" target="_blank">В админ панель</a></li>
                                                <li onclick="deleteThread({{thread.id}})" class="text-danger">Удалить тред</li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% if thread.pinned %}<img class="small-icon" src="{% static 'media/pin.png' %}" style="opacity: 0.5; width: 14px; margin-left: 5px;">{% endif %}
    
                                {% elif thread.pinned %}
                                    {% load static %}
                                    <img class="small-icon" src="{% static 'media/unpin.png' %}"></img>
                                {% endif %}
    
                                <img id="subscribe_button_{{thread.board.code}}_{{thread.id}}"class="small-icon subscribe-button" src="{% static 'media/subscribe.png' %}"></img>
                            </div>
						</div>

						<div class="thread-description" onclick="window.location.href='/boards/board/{{thread.board.code}}/thread/{{thread.id}}'">
							<h2>{{thread.formatted | safe}}</h2>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
		<div class="pagination bottom">
			<span class="step-links">
				{% if page_obj.has_previous %}
					<a href="?page=1{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">&laquo;1</a>
					{% if page_obj.previous_page_number != 1 %}
						<a href="?page={{ page_obj.previous_page_number }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">&lsaquo;{{ page_obj.previous_page_number }}</a>
					{% endif %}
				{% endif %}

				<span class="current">{{ page_obj.number }}</span>

				{% if page_obj.has_next %}
					{% if page_obj.next_page_number != page_obj.paginator.num_pages %}
						<a href="?page={{ page_obj.next_page_number }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">{{ page_obj.next_page_number }}&rsaquo;</a>
					{% endif %}
					<a href="?page={{ page_obj.paginator.num_pages }}{% if archive %}&archive=1{% endif %}{% if request.GET.noredirect %}&noredirect=1{% endif %}">{{ page_obj.paginator.num_pages }}&raquo;</a>
				{% endif %}
			</span>
		</div>
	</div>

	<div class="bottom-nav">
	    {% if not archive %}
	        <a class="threadlnk" href="?archive=1{% if request.GET.noredirect %}&noredirect=1{% endif %}">Архив борды</a>
	    {% else %}
	        <a class="threadlnk" href="?archive=0{% if request.GET.noredirect %}&noredirect=1{% endif %}">Плавающие треды</a>
	    {% endif %}
	
	    <span class="separator">|</span>
	
	    <a class="threadlnk" href="/boards/board/{{board.code}}/catalog">Каталог</a>
	</div>

	{% load static %}
	<script src="{% static 'js/draggable.js' %}"></script>
	<script src="{% static 'js/date_tooltip.js' %}"></script>

	<script>
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.admin-menu-trigger') && !e.target.closest('.admin-context-menu')) {
                document.querySelectorAll('.admin-context-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });

        function toggleContextMenu(e, id) {
            e.preventDefault();
            e.stopPropagation();
            
            document.querySelectorAll('.admin-context-menu').forEach(menu => {
                if (menu.id !== 'admin-menu-' + id) menu.classList.add('hidden');
            });
            
            const menu = document.getElementById('admin-menu-' + id);
            if (menu) menu.classList.toggle('hidden');
        }

        async function sendPostAction(url, id, nextUrl) {
            await fetch(url, {
                method: "POST",
                credentials: "include",
                headers: {'X-CSRFToken': Cookies.get("csrftoken")},
                body: JSON.stringify({
                    id: id,
                    next: nextUrl || window.location.href
                })
            });
            window.location.reload();
        }

		async function pin(id) { await sendPostAction("/boards/pin", id); }
		async function persist(id) { await sendPostAction("/boards/persist", id); }
        async function archiveThread(id) { await sendPostAction("/boards/archive", id); }

        async function deleteThread(id) {
            if (confirm("Вы точно хотите удалить этот тред? Это действие необратимо.")) {
                await sendPostAction("/boards/delete", id);
            }
        }
	</script>
{% endblock %}
